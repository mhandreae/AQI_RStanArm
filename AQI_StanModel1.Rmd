---
title: "Stan Model of AQI data"
author: "Michael Andreae"
output: html_document
---

# Insurance status predicts antiemetic use 
we build a random effects model with procedure as random effects

```{r, packages, message=FALSE, echo=FALSE, warning=FALSE}
library(knitr) # required to set options in Markdown R
library(lme4)
library(rstan)
library(rstanarm)
# library(nlme)
```



```{r, global_options, echo=FALSE}
# set options
opts_chunk$set(fig.width=6, fig.height=4, fig.path='Figs/',
               echo=FALSE, warning=FALSE, message=FALSE)
rm(list = ls())
everything<-FALSE
```

# Load cleaned complete case dataset
 
we load the cleaned dataset with procedure information *myAQI.Rdata* which we generated in the Project *AQI_Import*.   


```{r, load_clean_dataset, echo=TRUE}
load("Data/myAQI.Rdata")
str(myAQI)
```

# Logit Models

# Four Predictors

## Fixed Effects Model 

Link : logit
fitted with glm with **four** predictors: 

formula0 <- ond ~ pay +age_group +sex

```{r, log0, echo=TRUE, eval=everything}

formula2.0 <- ond ~ pay +age_group +sex

fit_log2.0 <- glm(formula2.0, 
             family = binomial(link = "logit"), 
             data = myAQI)
```

## Random Effects Model

fitted with glmer and procedure as random effect

```{r eval=everything, echo=TRUE}
formulaR2.0 <- ond ~ pay +age_group +sex + (1 | cpt)

m2.0 <- glmer(formulaR2.0, data = myAQI, family = binomial, 
           control = glmerControl(optimizer = "bobyqa"),
           nAGQ = 10)
save(fit_log2.0, m2.0, file = "Results/results2.0.Rdata")
```

## Stan Model

fitted with Rstanarm 2.7 using the same formula

```{r}
fit1 <-stan_glm(mpg ~ wt, data = mtcars)

ctl <- c(4.17,5.58,5.18,6.11,4.50,4.61,5.17,4.53,5.33,5.14)
trt <- c(4.81,4.17,4.41,3.59,5.87,3.83,6.03,4.89,4.32,4.69)
group <- gl(2, 10, 20, labels = c("Ctl","Trt"))
weight <- c(ctl, trt)
fit <- stan_glm(weight ~ group)
coef(fit)

counts <- c(18,17,15,20,10,20,25,13,12)
outcome <- gl(3,1,9)
treatment <- gl(3,3)
stan_glm(counts ~ outcome + treatment, family = poisson())
}
